<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>FTTH Estafet Mapper</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --onu: #2980b9; }
        body { margin: 0; font-family: sans-serif; background: #f4f4f4; }
        #map { height: 100vh; width: 100vw; }
        
        .menu-box {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: white; padding: 12px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 220px;
        }
        .btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        button {
            padding: 12px; border: none; border-radius: 6px;
            background: var(--primary); color: white; font-weight: bold; cursor: pointer;
        }
        button.active { background: var(--accent); outline: 3px solid #ffeb3b; }
        button.gps { background: #27ae60; }
        
        .info-bar {
            position: absolute; bottom: 30px; left: 10px; right: 10px;
            background: white; padding: 15px; border-radius: 12px;
            z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            max-height: 40vh; overflow-y: auto;
        }
        .selected-node { background: #fff3cd; padding: 5px; border-radius: 4px; margin-bottom: 10px; border: 1px solid #ffeeba; }
        .stat-row { display: flex; justify-content: space-between; font-size: 13px; border-bottom: 1px solid #eee; padding: 4px 0; }
        .bad { color: red; font-weight: bold; }
        .good { color: green; font-weight: bold; }
    </style>
</head>
<body>

<div class="menu-box">
    <div style="font-size: 14px; font-weight: bold;">FTTH CHAIN PLANNER</div>
    <div class="btn-group">
        <button class="gps" onclick="locateMe()">üìç LOKASI SAYA</button>
        <button id="btn-OLT" onclick="setMode('OLT')">1. PASANG OLT</button>
        <button id="btn-ODP" onclick="setMode('ODP')">2. PASANG ODP</button>
        <button id="btn-ONU" onclick="setMode('ONU')">3. PASANG ONU</button>
    </div>
    <div id="status-aktif" style="margin-top:10px; font-size: 11px; color: #666;">
        Pilih OLT untuk memulai.
    </div>
</div>

<div class="info-bar" id="info-bar">
    <div id="current-parent-display" class="selected-node">Sumber Aktif: <b>Belum Ada</b></div>
    <strong>Daftar Perangkat:</strong>
    <div id="device-list"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map = L.map('map').setView([-6.2000, 106.8166], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let nodes = [];
    let currentMode = null;
    let selectedParentId = null;

    // Spek Redaman (dB)
    const LOSS = { cable: 0.35, conn: 0.5, plc8: 10.5, fbt10: 10.5, fbt90: 0.8 };

    function locateMe() {
        map.locate({setView: true, maxZoom: 17});
    }

    map.on('locationfound', (e) => {
        L.circle(e.latlng, {radius: 10}).addTo(map);
    });

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        if(mode) document.getElementById('btn-' + mode).classList.add('active');
        document.getElementById('status-aktif').innerText = "Mode: Tambah " + mode;
    }

    map.on('click', function(e) {
        if (!currentMode) return;
        addNode(e.latlng);
    });

    function addNode(latlng) {
        let parent = nodes.find(n => n.id === selectedParentId);
        
        // Proteksi OLT hanya boleh satu di awal
        if (currentMode === 'OLT' && nodes.some(n => n.type === 'OLT')) {
            alert("OLT sudah ada. Silakan tambah ODP atau ONU.");
            return;
        }

        if (currentMode !== 'OLT' && !parent) {
            alert("Klik salah satu OLT atau ODP di peta sebagai sumber power!");
            return;
        }

        let node = {
            id: Date.now(),
            latlng: latlng,
            type: currentMode,
            parentId: selectedParentId || null,
            powerIn: 0,
            powerOutEstafet: 0, // Jalur ke ODP selanjutnya
            powerOutPelanggan: 0, // Jalur ke ONU
            portsUsed: 0,
            name: currentMode + " " + (nodes.length + 1)
        };

        if (currentMode === 'OLT') {
            node.powerIn = 7.0; // Input SFP
            node.powerOutEstafet = 7.0;
            selectedParentId = node.id; // Otomatis jadi parent
        } 
        else if (currentMode === 'ODP') {
            let dist = parent.latlng.distanceTo(latlng) / 1000;
            let cableLoss = (dist * LOSS.cable) + LOSS.conn;
            
            // Power masuk dari jalur Estafet parent
            node.powerIn = parent.powerOutEstafet - cableLoss;

            let isFBT = confirm("Gunakan FBT 90/10 untuk Estafet ke ODP lain?\n\nOK = FBT (Bisa Estafet)\nCancel = PLC 1:8 Murni (Buntu)");
            
            if (isFBT) {
                node.powerOutEstafet = node.powerIn - LOSS.fbt90; // Jalur lurus
                node.powerOutPelanggan = node.powerIn - LOSS.fbt10 - LOSS.plc8; // Jalur tap + splitter
                node.name += " (FBT)";
            } else {
                node.powerOutEstafet = -99; // Mati
                node.powerOutPelanggan = node.powerIn - LOSS.plc8;
                node.name += " (PLC)";
            }
            selectedParentId = node.id; // ODP baru otomatis jadi parent aktif
        } 
        else if (currentMode === 'ONU') {
            if (parent.type !== 'ODP') return alert("ONU harus dicolok ke ODP!");
            if (parent.portsUsed >= 8) return alert("Port ODP Penuh!");
            
            let dist = parent.latlng.distanceTo(latlng) / 1000;
            node.powerIn = parent.powerOutPelanggan - (dist * LOSS.cable) - LOSS.conn;
            node.name = "User ODP " + parent.id.toString().slice(-3);
            parent.portsUsed++;
        }

        nodes.push(node);
        updateUI();
    }

    function updateUI() {
        // Reset Map Layers
        map.eachLayer(l => { if(l instanceof L.CircleMarker || l instanceof L.Polyline) map.removeLayer(l); });

        let listHtml = "";
        nodes.forEach(n => {
            // Marker
            let color = n.type === 'OLT' ? 'black' : (n.type === 'ODP' ? '#e67e22' : '#2980b9');
            let radius = n.type === 'ONU' ? 5 : 8;
            
            let marker = L.circleMarker(n.latlng, {
                radius: radius,
                color: n.id === selectedParentId ? 'red' : 'white',
                fillColor: color,
                fillOpacity: 1,
                weight: 3
            }).addTo(map);

            marker.on('click', (e) => {
                L.DomEvent.stopPropagation(e);
                selectedParentId = n.id;
                updateUI();
            });

            marker.bindPopup(`<b>${n.name}</b><br>In: ${n.powerIn.toFixed(2)} dBm`);

            // Garis Kabel
            if (n.parentId) {
                let parent = nodes.find(p => p.id === n.parentId);
                let isFeeder = n.type === 'ODP';
                L.polyline([parent.latlng, n.latlng], {
                    color: isFeeder ? '#2c3e50' : '#3498db',
                    weight: isFeeder ? 4 : 2,
                    dashArray: isFeeder ? '' : '5,5'
                }).addTo(map);
            }

            // List UI
            let pColor = n.powerIn < -27 ? 'bad' : 'good';
            listHtml += `<div class="stat-row">
                <span>${n.name}</span>
                <span class="${pColor}">${n.powerIn.toFixed(2)} dBm</span>
            </div>`;
        });

        let activeParent = nodes.find(n => n.id === selectedParentId);
        document.getElementById('current-parent-display').innerHTML = 
            `Sumber Aktif: <b>${activeParent ? activeParent.name : 'Belum Ada'}</b><br>
             <small>Klik perangkat lain di peta untuk pindah sumber</small>`;
        
        document.getElementById('device-list').innerHTML = listHtml;
    }
</script>

</body>
</html>
