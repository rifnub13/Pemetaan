<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>FTTH Inventory Pro V6</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --dark: #1a1a1a; --gold: #f1c40f; --blue: #3498db; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--dark); color: white; }
        #map { height: 100vh; width: 100vw; }

        /* UI Panels */
        .panel { position: absolute; z-index: 1000; background: rgba(0,0,0,0.85); padding: 12px; border-radius: 12px; border: 1px solid #444; backdrop-filter: blur(5px); }
        .top-left { top: 10px; left: 10px; width: 180px; }
        .bottom-ui { bottom: 10px; left: 10px; right: 10px; display: flex; flex-direction: column; gap: 5px; }

        /* Buttons */
        button { border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 11px; width: 100%; margin-bottom: 4px; }
        .btn-add { background: #2ecc71; color: white; }
        .btn-util { background: #34495e; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .active { border: 2px solid white; box-shadow: 0 0 10px var(--blue); }

        /* Modal */
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; background: white; color: black; padding: 20px; border-radius: 15px; width: 85%; max-width: 350px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        input, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }

        /* Status Labels */
        .pwr-tag { background: #000; color: #0f0; padding: 2px 5px; border-radius: 4px; font-family: monospace; font-size: 10px; }
        .port-list { font-size: 11px; margin-top: 10px; border-top: 1px solid #ddd; padding-top: 5px; }
    </style>
</head>
<body>

<div class="panel top-left">
    <div style="font-size: 12px; margin-bottom: 8px; color: var(--gold); border-bottom: 1px solid #444;">FTTH DESIGNER V6</div>
    <button class="btn-add" id="btn-OLT" onclick="setMode('OLT')">‚ûï OLT SERVER</button>
    <button class="btn-add" id="btn-ODP" onclick="setMode('ODP')">‚ûï ODP (DIST)</button>
    <button class="btn-add" id="btn-ONU" onclick="setMode('ONU')">üè† ONU (USER)</button>
    <div style="margin: 8px 0;"></div>
    <button class="btn-util" onclick="exportJSON()">üì§ EXPORT DATA</button>
    <button class="btn-util" onclick="document.getElementById('importFile').click()">üì• IMPORT DATA</button>
    <input type="file" id="importFile" style="display:none" onchange="importJSON(event)">
    <button class="btn-danger" onclick="resetAll()">‚ö†Ô∏è RESET MAP</button>
</div>

<div class="panel bottom-ui">
    <div id="info-status" style="font-size: 11px;">Sumber Aktif: <span style="color:var(--gold)">Belum dipilih</span></div>
    <div style="display: flex; gap: 5px;">
        <button class="btn-util" style="width: auto;" onclick="undo()">UNDO</button>
        <button class="btn-util" style="width: auto;" onclick="saveLocal()">SAVE TO HP</button>
    </div>
</div>

<!-- Modal -->
<div id="modal-form" class="modal">
    <h3 id="m-title" style="margin:0">Konfigurasi</h3>
    <div id="m-body"></div>
    <button class="btn-add" onclick="commitNode()">KONFIRMASI</button>
    <button class="btn-util" style="background:#95a5a6" onclick="closeM()">BATAL</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { zoomControl: false }).setView([-6.2, 106.8], 13);
    L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { maxZoom: 21, subdomains:['mt0','mt1','mt2','mt3'] }).addTo(map);

    let nodes = JSON.parse(localStorage.getItem('ftth_v6_data')) || [];
    let curMode = null;
    let selId = null;
    let tempCoord = null;

    const LOSS_KM = 0.35;
    const LOSS_CONN = 0.5;
    const PLC = { "1:2": 3.5, "1:4": 7.2, "1:8": 10.5, "1:16": 13.8 };

    function setMode(m) {
        curMode = m;
        document.querySelectorAll('.btn-add').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+m).classList.add('active');
    }

    map.on('click', e => {
        if(!curMode) return;
        let parent = nodes.find(n => n.id === selId);
        if(curMode !== 'OLT' && (!parent || parent.type === 'ONU')) {
            alert("‚ö†Ô∏è Error: ONU tidak bisa mengeluarkan kabel! Pilih OLT/ODP.");
            return;
        }
        tempCoord = e.latlng;
        openM();
    });

    function openM() {
        const b = document.getElementById('m-body');
        document.getElementById('modal-form').style.display = 'block';
        if(curMode === 'OLT') b.innerHTML = `SFP Power: <input type="number" id="f-pwr" value="7"> Nama OLT: <input id="f-name" value="OLT Pusat">`;
        else if(curMode === 'ODP') b.innerHTML = `Type: <select id="f-type"><option value="FBT">FBT (Tapping)</option><option value="PLC">PLC Murni</option></select> Ratio Tap: <input type="number" id="f-ratio" value="10"> PLC Lokal: <select id="f-plc"><option value="1:8">1:8</option><option value="1:16">1:16</option></select>`;
        else b.innerHTML = `Nama Pelanggan: <input id="f-user" placeholder="Nama/Alamat"> Port ODP: <input type="number" id="f-port" value="1" min="1" max="16">`;
    }

    function commitNode() {
        let p = nodes.find(n => n.id === selId);
        let node = { id: Date.now(), latlng: tempCoord, type: curMode, parentId: selId, name: '', pIn: 0, pOutL: 0, pOutN: 0, ports: {} };

        if(curMode === 'OLT') {
            node.pIn = parseFloat(document.getElementById('f-pwr').value);
            node.pOutN = node.pIn;
            node.name = document.getElementById('f-name').value;
        } else {
            let dist = p.latlng.distanceTo(tempCoord) / 1000;
            let lC = (dist * LOSS_KM) + LOSS_CONN;
            node.pIn = (p.pOutN !== -99 ? p.pOutN : p.pOutL) - lC;

            if(curMode === 'ODP') {
                let plcL = PLC[document.getElementById('f-plc').value];
                if(document.getElementById('f-type').value === 'FBT') {
                    let r = parseInt(document.getElementById('f-ratio').value);
                    let lTap = -10 * Math.log10(r/100);
                    let lThru = -10 * Math.log10((100-r)/100);
                    node.pOutL = node.pIn - lTap - plcL;
                    node.pOutN = node.pIn - lThru;
                    node.name = `ODP ${100-r}/${r}`;
                } else {
                    node.pOutL = node.pIn - plcL;
                    node.pOutN = -99;
                    node.name = "ODP Murni";
                }
            } else { // ONU
                let portNo = document.getElementById('f-port').value;
                node.pIn = p.pOutL - lC;
                node.name = document.getElementById('f-user').value || "User";
                p.ports[portNo] = node.name; // Simpan di Inventory ODP
            }
        }
        nodes.push(node);
        selId = node.id;
        closeM(); render();
    }

    function render() {
        map.eachLayer(l => { if(l instanceof L.CircleMarker || l instanceof L.Polyline || l instanceof L.Marker) map.removeLayer(l); });
        nodes.forEach(n => {
            let c = n.pIn > -25 ? '#2ecc71' : (n.pIn > -27 ? '#f1c40f' : (n.pIn > -30 ? '#e74c3c' : '#000'));
            let m = L.circleMarker(n.latlng, { radius: n.id === selId ? 10 : 7, fillColor: c, color: '#fff', fillOpacity: 1, weight: 2 }).addTo(map);
            
            L.marker(n.latlng, { icon: L.divIcon({ className: 'pwr-tag', html: n.pIn.toFixed(1), iconSize: [35, 12], iconAnchor: [17, -12] }) }).addTo(map);

            m.on('click', e => { L.DomEvent.stopPropagation(e); selId = n.id; render(); });

            let pop = `<b>${n.name}</b><br>In: ${n.pIn.toFixed(2)} dBm<br>`;
            if(n.type === 'ODP') {
                pop += `<div class="port-list"><b>PORT INVENTORY:</b><br>`;
                for(let i=1; i<=8; i++) pop += `${i}: ${n.ports[i] || '<span style="color:gray">Kosong</span>'}<br>`;
                pop += `</div>`;
            }
            pop += `<button class="btn-danger" style="padding:2px; font-size:9px;" onclick="del(${n.id})">HAPUS</button>`;
            m.bindPopup(pop);

            if(n.parentId) {
                let p = nodes.find(x => x.id === n.parentId);
                L.polyline([p.latlng, n.latlng], { color: c, weight: n.type === 'ONU' ? 1.5 : 4, dashArray: n.type === 'ONU' ? '4,4' : '' }).addTo(map);
            }
        });
        saveLocal();
        const active = nodes.find(n => n.id === selId);
        document.getElementById('info-status').innerHTML = active ? `Sumber Aktif: <b style="color:var(--gold)">${active.name} (${active.pIn.toFixed(1)} dBm)</b>` : "Sumber Aktif: Pilih OLT/ODP";
    }

    function closeM() { document.getElementById('modal-form').style.display = 'none'; }
    function saveLocal() { localStorage.setItem('ftth_v6_data', JSON.stringify(nodes)); }
    function undo() { nodes.pop(); selId = nodes.length?nodes[nodes.length-1].id:null; render(); }
    function resetAll() { if(confirm("Hapus semua?")) { nodes=[]; localStorage.clear(); location.reload(); } }
    function del(id) { nodes = nodes.filter(n => n.id !== id); selId = null; render(); }

    function exportJSON() {
        const blob = new Blob([JSON.stringify(nodes)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "FTTH_Network_Data.json"; a.click();
    }

    function importJSON(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => { nodes = JSON.parse(ev.target.result); render(); };
        reader.readAsText(file);
    }

    render();
</script>
</body>
</html>
