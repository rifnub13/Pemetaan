<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>FTTH Planner V3 - Estafet Logic</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --success: #27ae60; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #000; }
        #map { height: 100vh; width: 100vw; }
        
        /* Floating UI */
        .ui-overlay { position: absolute; z-index: 1000; pointer-events: none; width: 100%; height: 100%; }
        .ui-overlay * { pointer-events: auto; }
        
        .top-menu { top: 10px; left: 10px; width: 180px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        
        .mini-log { 
            bottom: 10px; right: 10px; width: 200px; 
            background: rgba(255,255,255,0.9); padding: 8px; border-radius: 8px; font-size: 11px;
            max-height: 120px; overflow-y: auto; box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }

        /* Modals */
        .modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; background: white; padding: 15px; border-radius: 12px;
            width: 85%; max-width: 350px; box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        
        button { 
            width: 100%; padding: 10px; margin: 3px 0; border: none; border-radius: 5px; 
            background: var(--primary); color: white; font-weight: bold; cursor: pointer; font-size: 12px;
        }
        button.active { background: var(--accent); border: 2px solid #fff; }
        button.gps { background: var(--success); }
        
        input, select { width: 100%; padding: 8px; margin: 4px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .label-text { font-size: 11px; font-weight: bold; color: #555; display: block; margin-top: 5px; }
        .red-text { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div class="ui-overlay">
    <div class="top-menu">
        <button class="gps" onclick="locateMe()">üìç LOKASI SAYA</button>
        <div style="height: 1px; background: #ddd; margin: 5px 0;"></div>
        <button id="btn-OLT" onclick="setMode('OLT')">PASANG OLT</button>
        <button id="btn-ODP" onclick="setMode('ODP')">PASANG ODP</button>
        <button id="btn-ONU" onclick="setMode('ONU')">PASANG ONU</button>
        <button style="background:#7f8c8d;" onclick="saveData()">SIMPAN</button>
        <button style="background:#c0392b; font-size: 10px;" onclick="resetData()">RESET</button>
    </div>

    <div class="mini-log" id="mini-log">
        <strong>Status Parent:</strong>
        <div id="parent-info">Pilih Sumber Power</div>
    </div>
</div>

<!-- Modal Config -->
<div id="modal-config" class="modal">
    <h3 id="modal-title" style="margin-top:0;">Config</h3>
    <div id="modal-fields"></div>
    <button onclick="commitNode()">KONFIRMASI</button>
    <button onclick="closeModal()" style="background:#95a5a6;">BATAL</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { zoomControl: false }).setView([-6.2000, 106.8166], 13);
    L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
        maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map);

    let nodes = JSON.parse(localStorage.getItem('ftth_v3_data')) || [];
    let currentMode = null;
    let selectedParentId = null;
    let tempLatLng = null;

    const LOSS = { cable: 0.35, conn: 0.5 };
    const PLC_VALS = { "1:2": 3.5, "1:4": 7.2, "1:8": 10.5, "1:16": 13.8 };

    function locateMe() { map.locate({setView: true, maxZoom: 18}); }
    map.on('locationfound', (e) => L.circleMarker(e.latlng, {radius: 5, color: 'cyan'}).addTo(map));

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.top-menu button').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+mode).classList.add('active');
    }

    map.on('click', function(e) {
        if (!currentMode) return;
        tempLatLng = e.latlng;
        openModal();
    });

    function openModal() {
        const modal = document.getElementById('modal-config');
        const fields = document.getElementById('modal-fields');
        modal.style.display = 'block';

        if (currentMode === 'OLT') {
            document.getElementById('modal-title').innerText = "Konfigurasi OLT";
            fields.innerHTML = `
                <span class="label-text">Power SFP (dBm)</span>
                <select id="f-sfp"><option value="3">+3</option><option value="5">+5</option><option value="7" selected>+7</option><option value="9">+9</option></select>
                <span class="label-text">Nama Server</span>
                <input type="text" id="f-name" value="Pusat Server">
            `;
        } else if (currentMode === 'ODP') {
            document.getElementById('modal-title').innerText = "Konfigurasi ODP";
            fields.innerHTML = `
                <span class="label-text">Tipe Splitter</span>
                <select id="f-type" onchange="toggleODPFields()">
                    <option value="FBT">FBT (Tapping/Estafet)</option>
                    <option value="PLC">PLC (End Point)</option>
                </select>
                <div id="box-fbt">
                    <span class="label-text">Rasio Tap (%) - Masuk ke PLC</span>
                    <input type="number" id="f-ratio" value="10" min="1" max="99">
                </div>
                <span class="label-text">Pilih PLC Lokal (Untuk Pelanggan)</span>
                <select id="f-plc"><option value="1:2">1:2</option><option value="1:4">1:4</option><option value="1:8" selected>1:8</option><option value="1:16">1:16</option></select>
            `;
        } else if (currentMode === 'ONU') {
            document.getElementById('modal-title').innerText = "Data Pelanggan";
            fields.innerHTML = `
                <span class="label-text">Nama Pelanggan</span>
                <input type="text" id="f-name" placeholder="Contoh: Bpk. Ahmad">
                <span class="label-text">Keterangan / Alamat</span>
                <input type="text" id="f-desc" placeholder="Blok A No. 5">
            `;
        }
    }

    function toggleODPFields() {
        const type = document.getElementById('f-type').value;
        document.getElementById('box-fbt').style.display = (type === 'FBT') ? 'block' : 'none';
    }

    function commitNode() {
        let parent = nodes.find(n => n.id === selectedParentId);
        if (currentMode !== 'OLT' && !parent) return alert("Pilih sumber power (Klik marker OLT/ODP) dulu!");

        let node = {
            id: Date.now(), latlng: tempLatLng, type: currentMode, parentId: selectedParentId || null,
            name: '', powerIn: 0, powerOutLocal: 0, powerOutEstafet: 0, desc: ''
        };

        if (currentMode === 'OLT') {
            node.powerIn = parseFloat(document.getElementById('f-sfp').value);
            node.powerOutEstafet = node.powerIn;
            node.name = document.getElementById('f-name').value;
        } else {
            let dist = parent.latlng.distanceTo(tempLatLng) / 1000;
            let cableLoss = (dist * LOSS.cable) + LOSS.conn;
            node.powerIn = (parent.type === 'ONU' ? 0 : parent.powerOutEstafet) - cableLoss;

            if (currentMode === 'ODP') {
                const type = document.getElementById('f-type').value;
                const plcLoss = PLC_VALS[document.getElementById('f-plc').value];
                
                if (type === 'FBT') {
                    const ratio = parseInt(document.getElementById('f-ratio').value);
                    const lossTap = -10 * Math.log10(ratio/100);
                    const lossThru = -10 * Math.log10((100-ratio)/100);
                    node.powerOutLocal = node.powerIn - lossTap - plcLoss;
                    node.powerOutEstafet = node.powerIn - lossThru;
                    node.name = `ODP FBT ${100-ratio}:${ratio}`;
                } else {
                    node.powerOutLocal = node.powerIn - plcLoss;
                    node.powerOutEstafet = -99;
                    node.name = `ODP PLC ${document.getElementById('f-plc').value}`;
                }
            } else { // ONU
                node.powerIn = parent.powerOutLocal - cableLoss;
                node.name = document.getElementById('f-name').value || "Pelanggan";
                node.desc = document.getElementById('f-desc').value;
            }
        }

        nodes.push(node);
        selectedParentId = node.id; // Otomatis jadikan parent untuk klik berikutnya
        closeModal();
        render();
    }

    function render() {
        map.eachLayer(l => { if(l instanceof L.CircleMarker || l instanceof L.Polyline) map.removeLayer(l); });
        
        nodes.forEach(n => {
            let color = n.type === 'OLT' ? 'red' : (n.type === 'ODP' ? '#f39c12' : '#3498db');
            let marker = L.circleMarker(n.latlng, {
                radius: n.id === selectedParentId ? 12 : 7,
                color: '#fff', fillColor: color, fillOpacity: 1, weight: 2
            }).addTo(map);

            marker.on('click', (e) => {
                L.DomEvent.stopPropagation(e);
                selectedParentId = n.id;
                updateParentInfo(n);
                render();
            });

            let popupContent = `
                <div style="font-size:12px;">
                    <b>${n.name}</b><br>
                    Power In: <span class="${n.powerIn < -27 ? 'red-text':''}">${n.powerIn.toFixed(2)} dBm</span><br>
                    ${n.type === 'ODP' ? 'Out Lokal: ' + n.powerOutLocal.toFixed(2) + ' dBm<br>Out Estafet: ' + (n.powerOutEstafet < -50 ? 'OFF' : n.powerOutEstafet.toFixed(2)) : ''}
                    ${n.desc ? 'Ket: ' + n.desc : ''}
                </div>`;
            marker.bindPopup(popupContent);

            if (n.parentId) {
                let p = nodes.find(x => x.id === n.parentId);
                L.polyline([p.latlng, n.latlng], {
                    color: n.type === 'ONU' ? '#3498db' : '#f39c12',
                    weight: n.type === 'ONU' ? 2 : 4,
                    dashArray: n.type === 'ONU' ? '5,5' : ''
                }).addTo(map);
            }
        });
        
        const active = nodes.find(n => n.id === selectedParentId);
        if(active) updateParentInfo(active);
    }

    function updateParentInfo(n) {
        document.getElementById('parent-info').innerHTML = `
            <span style="color:blue">Aktif: ${n.name}</span><br>
            Power: ${n.powerIn.toFixed(2)} dBm
        `;
    }

    function closeModal() { document.getElementById('modal-config').style.display = 'none'; }
    function saveData() { localStorage.setItem('ftth_v3_data', JSON.stringify(nodes)); alert("Tersimpan di HP!"); }
    function resetData() { if(confirm("Hapus semua?")) { nodes = []; localStorage.clear(); location.reload(); } }

    render();
</script>

</body>
</html>
